version: '3.8'

services:
  # Router - acts as gateway between networks
  router:
    image: ubuntu:22.04
    container_name: lan_router
    hostname: router
    cap_add:
      - NET_ADMIN
    networks:
      lan_network:
        ipv4_address: 10.10.10.2
    command: >
      bash -c "
      apt-get update && 
      apt-get install -y iproute2 iputils-ping iptables net-tools &&
      echo 1 > /proc/sys/net/ipv4/ip_forward &&
      iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE &&
      tail -f /dev/null
      "
    stdin_open: true
    tty: true

  # Host A
  host_a:
    image: ubuntu:22.04
    container_name: lan_host_a
    hostname: host-a
    networks:
      lan_network:
        ipv4_address: 10.10.10.10
    command: >
      bash -c "
      apt-get update && 
      apt-get install -y iproute2 iputils-ping net-tools &&
      ip route del default &&
      ip route add default via 10.10.10.2 &&
      tail -f /dev/null
      "
    stdin_open: true
    tty: true
    depends_on:
      - router

  # Host B
  host_b:
    image: ubuntu:22.04
    container_name: lan_host_b
    hostname: host-b
    networks:
      lan_network:
        ipv4_address: 10.10.10.11
    command: >
      bash -c "
      apt-get update && 
      apt-get install -y iproute2 iputils-ping net-tools &&
      ip route del default &&
      ip route add default via 10.10.10.2 &&
      tail -f /dev/null
      "
    stdin_open: true
    tty: true
    depends_on:
      - router

  # Host C
  host_c:
    image: ubuntu:22.04
    container_name: lan_host_c
    hostname: host-c
    networks:
      lan_network:
        ipv4_address: 10.10.10.12
    command: >
      bash -c "
      apt-get update && 
      apt-get install -y iproute2 iputils-ping net-tools &&
      ip route del default &&
      ip route add default via 10.10.10.2 &&
      tail -f /dev/null
      "
    stdin_open: true
    tty: true
    depends_on:
      - router

networks:
  lan_network:
    driver: bridge
    ipam:
      config:
        - subnet: 10.10.10.0/24
          gateway: 10.10.10.1
